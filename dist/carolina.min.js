"use strict";!function(t){function e(){this.properties={options:{},logLevel:0,errorCount:0,isListening:!1,finalTranscript:"",lastTranscriptSentence:"",isSupportVoiceRecognition:!0},this.methodNames={initialize:"initialize",run:"run",setProp:"setProp",getProp:"getProp",invokeCallbacks:"invokeCallbacks",optionsToString:"optionsToString",doctor:"doctor",isListening:"isListening",isSupportVoiceRecognition:"isSupportVoiceRecognition"},this.logger,this.factory={}}function o(t,e){this.methodNames={debug:"debug",info:"info",error:"error",warn:"warn"},this.logLevel=e,this.fnClass=t,this.printLog=function(t,e,o){if(void 0!==this.logLevel&&this.logLevel!==l.NO_LOGS)return"function"!=typeof console[t]?void console.error("Trying to you console log with unknown console type => ",t):Array.isArray(o)&&o.length>0?void console[t](a.LIB_NAME+"::"+this.fnClass+":: "+e+" => ",o):void console[t](a.LIB_NAME+"::"+this.fnClass+":: "+e)}}function i(t){var e,i;return{start:function(){e=new Date},end:function(){i=new Date;var n=i.getTime()-e.getTime();o("debug",t+" took "+n+" ms to execute")}}}function n(e){function i(e){if(this.logger=o.create(n.CLASS,s.getProp("options").logLevel),!r(t))return this.logger.error("Your browser is not support webkit speech recognition."),void this.setProp("isSupportVoiceRecognition",!1);a.call(this,{lang:e.lang,continuous:e.continuous,interimResults:e.interimResults,maxAlternatives:e.maxAlternatives,quality:e.quality})}function r(t){return t.SpeechRecognition||t.webkitSpeechRecognition||t.mozSpeechRecognition||t.msSpeechRecognition||t.oSpeechRecognition}function a(e){if(this.record)return void this.logger.error("You cannot initialized the webkit speech recognition twice!, you should kill the current instance and initialized again.");this.record=new(r(t)),this.record.lang=e.lang,this.record.continuous=e.continuous,this.record.interimResults=e.interimResults,this.record.maxAlternatives=e.maxAlternatives,this.quality=e.quality,this.record.onstart=u.bind(this),this.record.onresult=l.bind(this),this.record.onerror=g.bind(this),this.record.onend=p.bind(this),this.record.onnomatch=d.bind(this),this.record.onsoundstart=h.bind(this),this.record.onsoundend=f.bind(this),this.record.onspeechstart=v.bind(this),this.record.onspeechend=b.bind(this)}function l(t){var e="",o=s.getProp("finalTranscript");s.setProp("lastTranscriptSentence",o);for(var i=t.resultIndex;i<t.results.length;++i){var n=t.results[i][0].transcript,r=t.results[i][0].confidence;if(this.quality!==Math.round(r))return this.logger.debug("The transcript we capture from speaking is not confidence enough due to your quality restrictions => ",n),void s.invokeCallbacks(c.ON_BAD_QUALITY,n);t.results[i].isFinal?(this.logger.debug("Recevied new chunk transcript from user speaking text value & confidence => ",n,r),s.invokeCallbacks(c.ON_CHUNK_STREAM,n)):(e+=n,this.logger.debug("Interim transcript current speaking value => ",e),s.invokeCallbacks(c.ON_INTERIM_TRANSCRIPT,e))}var a=o+n;this.logger.debug("Live stream of transcript => ",a),s.setProp("finalTranscript",a).invokeCallbacks(c.ON_LIVE_STREAM,a)}function u(){s.setProp("isListening",!0),this.logger.debug("Start listening... "),s.invokeCallbacks(c.ON_START)}function g(t){var e=s.getProp("errorCount");e++,s.setProp("errorCount",e).setProp("isListening",!1),this.logger.error("An error been occured => ",t),s.invokeCallbacks(c.ON_ERROR,t)}function p(t){s.setProp("finalTranscript","").setProp("isListening",!1),this.logger.info("Stop listening... "),s.invokeCallbacks(c.ON_END,t)}function h(t){this.logger.debug("Sound recognisable speech or not has been detected"),s.invokeCallbacks(c.ON_SOUND_START,t)}function d(t){this.logger.debug("Speech recognition service returns a final result with no significant recognition. This may involve some degree of recognition, which doesnt meet or exceed the confidence threshold."),s.invokeCallbacks(c.ON_NO_MATCH,t)}function f(t){this.logger.debug("Any sound recognisable speech or not has stopped being detected."),s.invokeCallbacks(c.ON_SOUND_END,t)}function v(t){this.logger.debug("A sound that is recognised by the speech recognition service as speech has been detected."),s.invokeCallbacks(c.ON_SPEECH_START,t)}function b(t){this.logger.debug("Speech recognised by the speech recognition service has stopped being detected."),s.invokeCallbacks(c.ON_SPEECH_END,t)}var O=this;return this.record,this.quality,this.logger,i.call(O,e),{start:function(){O.record.start()},abort:function(){O.record.abort()},stop:function(){O.record.stop()}}}function r(){function e(e){if(this.logger=o.create(r.CLASS,s.getProp("options").logLevel),!t.plugins.speechRecognition)return this.logger.error("For ios and webapps you should have install the speechRecognition plugin."),void this.setProp("isSupportVoiceRecognition",!1);this.record=t.plugins.speechRecognition,Object.assign({},s.getProp.call(this,"options"),{lang:e.lang,matches:e.maxAlternatives})}function i(){return new Promise(function(t,e){this.record.hasPermission(function(e){t(e)},e(s.invokeCallbacks(c.ON_ERROR)))})}function n(){return new Promise(function(t,e){this.record.requestPermission(t(!0),function(t){e(s.invokeCallbacks(c.ON_ERROR))})})}function a(t){}function l(t){s.invokeCallbacks(c.ON_END,t)}function u(t){s.invokeCallbacks(c.ON_ERROR,t)}var g=this;return this.record,this.properties={hasPermission:!1,options:{}},e.call(g,config),{start:function(){if(!s.getProp.call(g,"hasPermission"))return void i().then(function(t){return t?(s.setProp.call(g,t),s.setProp("isListening",!0),g.record.startListening(a.bind(g),u,s.getProp.call(g,"options")),!1):n()}).then(function(t){t&&g.record.startListening(a.bind(g),u,s.getProp.call(g,"options"))});g.record.startListening(a.bind(g),u,s.getProp.call(g,"options"))},abort:function(){s.setProp("isListening",!1),g.record.stopListening(l,u)},stop:function(){s.setProp("isListening",!1),g.record.stopListening(l,u)}}}var s,c={ON_START:"onStart",ON_END:"onEnd",ON_ERROR:"onError",ON_LIVE_STREAM:"onLiveStream",ON_CHUNK_STREAM:"onChunkStream",ON_INTERIM_TRANSCRIPT:"onInterimTranscript",ON_SOUND_START:"onSoundStart",ON_NO_MATCH:"onNoMatch",ON_SOUND_END:"onSoundEnd",ON_SPEECH_START:"onSpeechStart",ON_SPEECH_END:"onSpeechEnd",ON_BAD_QUALITY:"onBadQuality"},a={VERSION:"1.0.0",LIB_NAME:"CAROLINA"},l={NO_LOGS:0,INFO_MODE:1,DEBUG_MODE:2,ULTRA_DEBUG_MODE:3},u=["start","stop","abort","isListening","doctor","isSupportVoiceRecognition"],g={GOOD:1,BAD:0};e.CLASS="Lib",e.create=function(){return new e},e.prototype.initialize=function(t){var i;return i=Object.assign({},this.getProp("options"),{lang:t.lang||"en-US",logLevel:"number"==typeof t.logLevel?t.logLevel:l.INFO_MODE,quality:"number"!=typeof t.quality?t.quality:g.GOOD,continuous:t.continuous||!1,interimResults:t.interimResults||!1,maxAlternatives:t.maxAlternatives||1,callbacks:t.callbacks}),this.logger=o.create(e.CLASS,i.logLevel),this.setProp("options",i),this},e.prototype.run=function(e){var o=t.navigator.standalone,i=t.navigator.userAgent.toLowerCase(),s=/safari/.test(i);/iphone|ipod|ipad/.test(i)?!o&&s?(this.logger.error("Apple not giving any way to use speech recognition via browser."),this.setProp("isSupportVoiceRecognition",!1)):o&&!s||o||s||(this.factory.functions=r.create(this.getProp("options"))):this.factory.functions=n.create(this.getProp("options")),e.call(null,this.factory)},e.prototype.setProp=function(t,e){return"undefiend"==typeof this.properties[t]?void this.logger.error("You cannot set to not exist property a value."):(this.logger.silly("Setting new value for "+t+" => ",e),this.properties[t]=e,this)},e.prototype.getProp=function(t){return this.properties[t]},e.prototype.invokeCallbacks=function(t){var e=this.getProp("options").callbacks;if(!e)return void this.logger.debug("There is no configured callbacks!");if(!e[t])return void this.logger.debug("There is no callback configured for callback name => ",t);for(var o=arguments.length,i=Array(o>1?o-1:0),n=1;n<o;n++)i[n-1]=arguments[n];e[t].apply(e.context,i)},e.prototype.optionsToString=function(){var t="\n",e=this.getProp("options");return Object.keys(e).map(function(o,i,n){"toString"!==o&&(t+=o+" => "+e[o],i!==n.length-1&&(t+="\n"))}),t},e.prototype.doctor=function(){var t="Library "+a.LIB_NAME+" v"+a.VERSION+"\nLog level is "+(this.getProp("options").logLevel?"ON":"OFF")+" \nConfiguration details are: "+this.optionsToString()+"\nLibrary health condition "+(this.getProp("errorCount")>3?"POOR":"GOOD")+"\nQuality of speaking "+(this.getProp("options").quality===g.GOOD?"GOOD":"POOR");this.logger.info(t)},e.prototype.isListening=function(){return this.getProp("isListening")},e.prototype.isSupportVoiceRecognition=function(){return this.getProp("isSupportVoiceRecognition")},o.CLASS="logger",o.create=function(t,e){return new o(t,e)},o.prototype.debug=function(t){if(!(this.logLevel<l.DEBUG_MODE)){for(var e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];this.printLog(this.methodNames.debug,t,o)}},o.prototype.info=function(t){if(!(this.logLevel<l.INFO_MODE)){for(var e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];this.printLog(this.methodNames.info,t,o)}},o.prototype.error=function(t){if(!(this.logLevel<l.INFO_MODE)){for(var e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];this.printLog(this.methodNames.error,t,o)}},o.prototype.warn=function(t){if(!(this.logLevel<l.INFO_MODE)){for(var e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];this.printLog(this.methodNames.warn,t,o)}},o.prototype.silly=function(t){if(!(this.logLevel<l.ULTRA_DEBUG_MODE)){for(var e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];this.printLog(this.methodNames.debug,t,o)}},i.prototype.create=function(t){return properties.isDebug?new i(t):{start:function(){},end:function(){}}},n.CLASS="browserVoiceRecognition",n.create=function(t){return new n(t)},r.CLASS="webviewVoiceRecognition",r.create=function(t){return new r(t)},t.Carolina={init:function(o){s=e.create(),s.initialize(o).run(function(e){e.functions&&Object.keys(e.functions).map(function(o){t.Carolina[o]=e.functions[o]}),u.map(function(e){"function"!=typeof t.Carolina[e]&&(t.Carolina[e]=s[e]?s[e].bind(s):function(){})})}),s.doctor(),delete t.Carolina.init}}}(window);